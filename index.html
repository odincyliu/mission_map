<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>è²“å’ªé—–é—œåœ°åœ–ï½œå°å››ãƒ»æ¯æ—¥ä¸€é—œ</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#fffdf7; --ink:#222; --soft:#f7efe3; --accent:#ffb703; --accent2:#8ecae6; --success:#76c893;
    }
    body{font-family:'Noto Sans TC', system-ui, -apple-system, Segoe UI, Roboto, 'Helvetica Neue', Arial; background:var(--bg); color:var(--ink);}  
    .app-title{font-weight:900; letter-spacing:1px}
    .cat-badge{font-size:1.25rem;}
    .card{border:none; border-radius:1rem; box-shadow:0 8px 24px rgba(0,0,0,.08);} 
    .map-wrap{background:linear-gradient(180deg, #fffaf0, #fff); border-radius:1rem; position:relative; padding:1.25rem}
    .checkpoint{width:72px; height:72px; border-radius:50%; background:#fff; border:3px dashed #e7d8c7; display:flex; align-items:center; justify-content:center; position:relative; transition:transform .2s;}
    .checkpoint .day{position:absolute; top:-1.25rem; font-weight:700; font-size:.9rem}
    .checkpoint .cat{font-size:2rem; line-height:1}
    .checkpoint.today{border-style:solid; border-color:var(--accent); box-shadow:0 0 0 8px rgba(255,183,3,.15);}
    .checkpoint.done{background:var(--success); border-color:var(--success); color:#fff}
    .checkpoint.done .cat{filter:grayscale(0)}
    .checkpoint:hover{transform:translateY(-2px)}
    .path{position:absolute; left:0; top:0; right:0; bottom:0; pointer-events:none}
    .paw{font-size:1.2rem; opacity:.28}
    .sticker{width:64px; height:64px; background:#fff; border:2px dashed #e7d8c7; border-radius:.75rem; display:flex; align-items:center; justify-content:center}
    .sticker.filled{border-color:var(--accent2); background:linear-gradient(180deg,#fff,#eef8ff)}
    .sticker .bigcat{font-size:1.8rem}
    .rule-list li{margin-bottom:.25rem}
    .task-check input[type="checkbox"]{transform:scale(1.2); margin-right:.4rem}
    .btn-cat{background:var(--accent); color:#000; border:none; font-weight:700}
    .btn-cat:disabled{background:#e8dcc6;color:#8b8b8b}

    @media print{
      .no-print{display:none !important}
      .container{max-width:100%}
      body{background:#fff}
      .card{box-shadow:none; border:1px solid #eee}
    }
  </style>
</head>
<body>
  <div class="container py-4">
    <div class="d-flex align-items-center justify-content-between mb-3">
      <h1 class="app-title">ğŸ¾ è²“å’ªé—–é—œåœ°åœ– <span class="fs-5 text-muted">ï½œå°å››ãƒ»æ¯æ—¥ä¸€é—œ</span></h1>
      <div class="no-print">
        <button id="btnPrint" class="btn btn-outline-secondary me-2">ğŸ–¨ï¸ åˆ—å°</button>
        <button id="btnExport" class="btn btn-outline-primary me-2">ğŸ“¤ åŒ¯å‡ºé€²åº¦</button>
        <label class="btn btn-outline-success mb-0">
          ğŸ“¥ åŒ¯å…¥é€²åº¦ <input type="file" id="importFile" hidden accept="application/json" />
        </label>
      </div>
    </div>

    <div class="row g-4">
      <!-- ä»Šæ—¥ä»»å‹™ -->
      <div class="col-lg-5">
        <div class="card p-3">
          <div class="d-flex align-items-center mb-2">
            <span class="cat-badge me-2">ğŸ˜º</span>
            <h5 class="mb-0">ä»Šæ—¥ä»»å‹™ï¼ˆå®Œæˆ 3 é …å³å¯è«‹å®¶é•·å‹¾é¸ï¼‰</h5>
          </div>
          <div id="todayInfo" class="text-muted mb-3 small"></div>

          <div id="taskList" class="mb-2"></div>
          <div id="taskCounter" class="small text-muted mb-3"></div>

          <div class="input-group input-group-sm mb-3">
            <label class="input-group-text" for="taskCategory">æ–°å¢ä»»å‹™</label>
            <select id="taskCategory" class="form-select">
              <option value="ä½œæ¥­">ä½œæ¥­</option>
              <option value="è¤‡ç¿’">è¤‡ç¿’</option>
              <option value="æ•´ç†æ›¸åŒ…">æ•´ç†æ›¸åŒ…</option>
              <option value="é–±è®€">é–±è®€</option>
              <option value="å…¶ä»–">å…¶ä»–</option>
            </select>
            <input id="taskDetail" type="text" class="form-control" placeholder="è¼¸å…¥è©³ç´°å…§å®¹ï¼Œä¾‹å¦‚ï¼šåœ‹ç¿’3" />
            <button id="btnAddTask" class="btn btn-outline-secondary">â•</button>
          </div>

          <div class="form-check form-switch mb-1">
            <input class="form-check-input" type="checkbox" role="switch" id="chkParentPass">
            <label class="form-check-label" for="chkParentPass">å®¶é•·å‹¾é¸ï¼šä»Šæ—¥é—–é—œæˆåŠŸ</label>
          </div>
          <div id="parentPassNote" class="small text-muted mb-3"></div>

          <div class="d-flex gap-2">
            <button id="btnResetToday" class="btn btn-outline-danger">â†º é‡ç½®ä»Šæ—¥</button>
          </div>
          <div id="msg" class="mt-3"></div>

          <hr>
          <ul class="rule-list small mb-0">
            <li>æ¯å¤©åªæœ‰ <b>1 é—œ</b>ï¼Œå®Œæˆä¸‰é …ä»»å‹™å¾Œè«‹å®¶é•·å‹¾é¸ã€Œä»Šæ—¥é—–é—œæˆåŠŸã€ã€‚</li>
            <li>é—–é—œæˆåŠŸæœƒåœ¨åœ°åœ–ä¸Šè“‹ç« ï¼Œä¸¦ç²å¾—éš¨æ©Ÿå°è²“è²¼ç´™ã€‚</li>
            <li>æ¯é€±ä¸€è‡ªå‹•é–‹å•Ÿæ–°åœ°åœ–ï¼ˆä¿ç•™ä¸Šé€±è¨˜éŒ„ï¼Œå¯åŒ¯å‡ºå‚™ä»½ï¼‰ã€‚</li>
          </ul>
        </div>
      </div>

      <!-- åœ°åœ–å€ -->
      <div class="col-lg-7">
        <div class="card p-3">
          <div class="d-flex align-items-center mb-2">
            <span class="cat-badge me-2">ğŸ¾</span>
            <h5 class="mb-0">æœ¬é€±é—–é—œåœ°åœ–</h5>
          </div>
          <div id="weekInfo" class="text-muted small mb-3"></div>

          <div class="map-wrap position-relative">
            <div class="row row-cols-2 row-cols-sm-4 row-cols-md-7 g-3" id="mapRow"></div>
          </div>

          <div class="mt-4">
            <div class="d-flex align-items-center mb-2">
              <span class="cat-badge me-2">ğŸ</span>
              <h6 class="mb-0">æœ¬é€±è²¼ç´™æ”¶è—</h6>
            </div>
            <div class="row g-2" id="stickerRow"></div>
          </div>

          <div class="mt-3 d-flex gap-2 no-print">
            <button id="btnNewWeek" class="btn btn-outline-secondary">ğŸ†• é–‹æ–°åœ°åœ–ï¼ˆæœ¬é€±é‡ç½®ï¼‰</button>
            <button id="btnClearAll" class="btn btn-outline-danger">ğŸ—‘ï¸ æ¸…é™¤æ‰€æœ‰è³‡æ–™</button>
          </div>
        </div>
      </div>
    </div>

    <footer class="text-center text-muted small mt-4">
      ç”±å®¶é•·èˆ‡å­©å­ä¸€èµ·ä½¿ç”¨ï¼šå®Œæˆä»»å‹™ â†’ å®¶é•·å‹¾é¸é—–é—œæˆåŠŸ â†’ æ”¶é›†å°è²“è²¼ç´™ã€‚
    </footer>
  </div>

  <script>
    // === å·¥å…· ===
    const catSet = ["ğŸ±","ğŸˆ","ğŸ˜¸","ğŸ˜º","ğŸ˜»","ğŸ˜½","ğŸ™€","ğŸ˜¼","ğŸ˜¹","ğŸ¾"]; // éš¨æ©Ÿè²¼ç´™

    // å–å¾—ç•¶åœ°æ™‚é–“ï¼ˆä»¥ä½¿ç”¨è€…ç€è¦½å™¨ç‚ºæº–ï¼‰
    function todayYMD(){
      const d = new Date();
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,'0');
      const day = String(d.getDate()).padStart(2,'0');
      return `${y}-${m}-${day}`;
    }
    function weekStart(d){ // ä»¥é€±ä¸€ç‚ºä¸€é€±èµ·å§‹
      const x = new Date(d);
      const day = x.getDay(); // 0(æ—¥)-6(å…­)
      const diff = (day===0? -6 : 1) - day; // è½‰åˆ°é€±ä¸€
      x.setDate(x.getDate()+diff);
      x.setHours(0,0,0,0);
      return x;
    }
    function fmtDate(d){
      return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
    }

    // LocalStorage Key ä»¥é€±ä¸€æ—¥æœŸå‘½å
    function storageKey(prefix){
      const ws = weekStart(new Date());
      return `${prefix}:${fmtDate(ws)}`;
    }

    function loadJSON(key, fallback){
      try{ return JSON.parse(localStorage.getItem(key)) ?? fallback; }catch(e){ return fallback; }
    }
    function saveJSON(key, obj){
      localStorage.setItem(key, JSON.stringify(obj));
    }

    // === ç‹€æ…‹ ===
    const WEEK_DAYS = ["é€±ä¸€","é€±äºŒ","é€±ä¸‰","é€±å››","é€±äº”","é€±å…­","é€±æ—¥"];

    const state = {
      weekKey: storageKey('catmap'),
      weekData: null,
      today: todayYMD(),
    };

    function uid(){
      if(window.crypto && window.crypto.randomUUID){
        return window.crypto.randomUUID();
      }
      return 't' + Math.random().toString(36).slice(2,9);
    }

    function defaultTasks(){
      return [
        {id:uid(), category:'ä½œæ¥­', detail:'', done:false},
        {id:uid(), category:'è¤‡ç¿’', detail:'', done:false},
        {id:uid(), category:'æ•´ç†æ›¸åŒ…', detail:'', done:false}
      ];
    }

    function ensureDayStructure(day){
      if(!day.tasks){
        day.tasks = defaultTasks();
      }else if(!Array.isArray(day.tasks)){
        const obj = day.tasks;
        const arr = [];
        if(Object.prototype.hasOwnProperty.call(obj, 'hw')){
          arr.push({id:uid(), category:'ä½œæ¥­', detail:'', done:!!obj.hw});
        }
        if(Object.prototype.hasOwnProperty.call(obj, 'review')){
          arr.push({id:uid(), category:'è¤‡ç¿’', detail:'', done:!!obj.review});
        }
        if(Object.prototype.hasOwnProperty.call(obj, 'bag')){
          arr.push({id:uid(), category:'æ•´ç†æ›¸åŒ…', detail:'', done:!!obj.bag});
        }
        day.tasks = arr.length ? arr : defaultTasks();
      }
      if(typeof day.passed !== 'boolean'){ day.passed = !!day.passed; }
      if(typeof day.sticker !== 'string'){ day.sticker = day.sticker ? String(day.sticker) : ''; }
    }

    function initWeek(){
      const ws = weekStart(new Date());
      const we = new Date(ws); we.setDate(we.getDate()+6);
      const weekTitle = `${fmtDate(ws)} ~ ${fmtDate(we)}`;
      document.getElementById('weekInfo').textContent = `æœ¬é€±ï¼š${weekTitle}`;

      const key = state.weekKey;
      const defaultData = {
        weekStart: fmtDate(ws),
        days: Array.from({length:7}, (_,i)=>({
          date: fmtDate(new Date(ws.getFullYear(), ws.getMonth(), ws.getDate()+i)),
          tasks: defaultTasks(),
          passed: false,
          sticker: ''
        }))
      };
      state.weekData = loadJSON(key, defaultData);
      // è‹¥è·¨é€±ï¼Œè‡ªå‹•æ–°å»º
      if(state.weekData.weekStart !== fmtDate(ws)){
        state.weekData = defaultData;
        saveJSON(key, state.weekData);
      }
      state.weekData.days.forEach(ensureDayStructure);
      render();
    }

    function dayIndexByDate(dateStr){
      return state.weekData.days.findIndex(d=>d.date===dateStr);
    }

    function render(){
      const mapRow = document.getElementById('mapRow');
      mapRow.innerHTML = '';
      const stickerRow = document.getElementById('stickerRow');
      stickerRow.innerHTML = '';

      const todayStr = state.today;
      const todayIdx = dayIndexByDate(todayStr);

      state.weekData.days.forEach((d, i)=>{
        const isToday = i===todayIdx;
        const isDone = !!d.passed;
        const col = document.createElement('div');
        const cp = document.createElement('div');
        cp.className = 'checkpoint d-flex flex-column text-center mx-auto ' + (isToday? 'today ':'') + (isDone? 'done ':'');
        cp.innerHTML = `<div class="day">${WEEK_DAYS[i]}</div><div class="cat">${isDone ? 'ğŸ…' : 'ğŸ¾'}</div>`;
        col.appendChild(cp);
        mapRow.appendChild(col);

        const sCol = document.createElement('div'); sCol.className='col-3 col-md-2 col-lg-1';
        const sticker = document.createElement('div');
        sticker.className = 'sticker ' + (d.sticker? 'filled':'');
        sticker.title = d.date;
        sticker.innerHTML = `<span class="bigcat">${d.sticker || 'ğŸ”²'}</span>`;
        sCol.appendChild(sticker); stickerRow.appendChild(sCol);
      });

      const dNow = new Date();
      const info = document.getElementById('todayInfo');
      info.textContent = `ä»Šå¤©ï¼š${fmtDate(dNow)}ï¼ˆ${['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'][dNow.getDay()]}ï¼‰`;

      renderTodayTasks();
    }

    function renderTodayTasks(){
      const container = document.getElementById('taskList');
      container.innerHTML = '';
      const idx = dayIndexByDate(state.today);
      const day = state.weekData.days[idx];
      if(!day){ return; }
      ensureDayStructure(day);
      const totalCount = day.tasks.length;
      let doneCount = 0;
      day.tasks.forEach(task=>{
        const wrapper = document.createElement('div');
        wrapper.className = 'task-check form-check d-flex align-items-center justify-content-between gap-2 mb-2';

        const left = document.createElement('div');
        left.className = 'd-flex align-items-center flex-grow-1';

        const checkbox = document.createElement('input');
        checkbox.className = 'form-check-input me-2';
        checkbox.type = 'checkbox';
        checkbox.id = `task-${task.id}`;
        checkbox.dataset.taskId = task.id;
        checkbox.checked = !!task.done;
        if(task.done) doneCount += 1;

        const label = document.createElement('label');
        label.className = 'form-check-label flex-grow-1';
        label.setAttribute('for', checkbox.id);
        label.textContent = task.detail ? `${task.category} - ${task.detail}` : task.category;

        left.appendChild(checkbox);
        left.appendChild(label);

        const removeBtn = document.createElement('button');
        removeBtn.className = 'btn btn-sm btn-outline-danger';
        removeBtn.type = 'button';
        removeBtn.dataset.removeTaskId = task.id;
        removeBtn.textContent = 'åˆªé™¤';

        wrapper.appendChild(left);
        wrapper.appendChild(removeBtn);
        container.appendChild(wrapper);
      });

      const parentCheck = document.getElementById('chkParentPass');
      parentCheck.checked = !!day.passed;
      const lock = doneCount < 3 && !day.passed;
      parentCheck.disabled = lock;

      const counter = document.getElementById('taskCounter');
      if(counter){
        counter.textContent = totalCount ? `å·²å®Œæˆ ${doneCount} / ${totalCount} é …ä»»å‹™ã€‚` : 'å°šæœªåŠ å…¥ä»»å‹™ã€‚';
      }

      const note = document.getElementById('parentPassNote');
      if(note){
        note.textContent = lock ? 'éœ€å®Œæˆè‡³å°‘ 3 é …ä»»å‹™å¾Œæ‰èƒ½å‹¾é¸é—–é—œæˆåŠŸã€‚' : 'å®¶é•·å¯å‹¾é¸ä»Šæ—¥é—–é—œæˆåŠŸï¼Œè“‹ç« ä¸¦å–å¾—è²¼ç´™ã€‚';
      }
    }

    function toggleTask(taskId, value){
      const idx = dayIndexByDate(state.today);
      const day = state.weekData.days[idx];
      const task = day.tasks.find(t=>t.id===taskId);
      if(!task) return;
      task.done = !!value;
      saveJSON(state.weekKey, state.weekData);
      renderTodayTasks();
    }

    function addTask(category, detail){
      const idx = dayIndexByDate(state.today);
      const day = state.weekData.days[idx];
      ensureDayStructure(day);
      const trimmedDetail = detail.trim();
      const task = { id: uid(), category, detail: trimmedDetail, done: false };
      day.tasks.push(task);
      saveJSON(state.weekKey, state.weekData);
      renderTodayTasks();
    }

    function removeTask(taskId){
      const idx = dayIndexByDate(state.today);
      const day = state.weekData.days[idx];
      const before = day.tasks.length;
      day.tasks = day.tasks.filter(t=>t.id!==taskId);
      if(day.tasks.length !== before){
        saveJSON(state.weekKey, state.weekData);
        renderTodayTasks();
      }
    }

    function resetToday(){
      const idx = dayIndexByDate(state.today);
      const day = state.weekData.days[idx];
      day.tasks = defaultTasks();
      day.passed = false; day.sticker='';
      saveJSON(state.weekKey, state.weekData);
      render();
      toastMsg('å·²é‡ç½®ä»Šæ—¥é€²åº¦ã€‚', 'info');
    }

    function newWeek(){
      if(!confirm('ç¢ºå®šè¦é‡ç½®æœ¬é€±åœ°åœ–ï¼Ÿæ­¤å‹•ä½œä¸å¯å¾©åŸã€‚')) return;
      const ws = weekStart(new Date());
      state.weekData = {
        weekStart: fmtDate(ws),
        days: Array.from({length:7}, (_,i)=>({
          date: fmtDate(new Date(ws.getFullYear(), ws.getMonth(), ws.getDate()+i)),
          tasks: defaultTasks(),
          passed:false, sticker:''
        }))
      };
      saveJSON(state.weekKey, state.weekData);
      render();
      toastMsg('å·²å»ºç«‹æ–°åœ°åœ–ã€‚', 'info');
    }

    function setParentPass(val){
      const idx = dayIndexByDate(state.today);
      const day = state.weekData.days[idx];
      if(!day) return;
      const checked = !!val;
      if(checked){
        if(!day.passed){
          day.passed = true;
          if(!day.sticker){
            day.sticker = catSet[Math.floor(Math.random()*catSet.length)];
          }
          toastMsg(`é—–é—œæˆåŠŸï¼å¾—åˆ°è²¼ç´™ ${day.sticker} `, 'success');
        }
      }else{
        if(day.passed){
          day.passed = false;
          day.sticker = '';
          toastMsg('å·²å–æ¶ˆä»Šæ—¥é—–é—œæˆåŠŸã€‚', 'info');
        }
      }
      saveJSON(state.weekKey, state.weekData);
      render();
    }

    function clearAll(){
      if(!confirm('æ¸…é™¤æ‰€æœ‰å„²å­˜è³‡æ–™ï¼Ÿï¼ˆåŒ…å«æ­·å²é€±ï¼‰')) return;
      Object.keys(localStorage).forEach(k=>{ if(k.startsWith('catmap:')) localStorage.removeItem(k); });
      initWeek();
      toastMsg('è³‡æ–™å·²å…¨éƒ¨æ¸…é™¤ã€‚', 'info');
    }

    function toastMsg(text, type='info'){
      const msg = document.getElementById('msg');
      const cls = type==='success'? 'alert-success' : (type==='info'? 'alert-secondary' : 'alert-warning');
      msg.innerHTML = `<div class="alert ${cls} py-2 px-3 mb-0">${text}</div>`;
      setTimeout(()=>{ msg.innerHTML=''; }, 2800);
    }

    function exportData(){
      const blob = new Blob([JSON.stringify(state.weekData, null, 2)], {type:'application/json'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `catmap-${state.weekData.weekStart}.json`;
      document.body.appendChild(a); a.click(); a.remove();
    }

    function importData(file){
      const reader = new FileReader();
      reader.onload = (e)=>{
        try{
          const obj = JSON.parse(e.target.result);
          if(!obj || !obj.weekStart || !Array.isArray(obj.days) || obj.days.length!==7){
            alert('æ ¼å¼ä¸æ­£ç¢º'); return;
          }
          state.weekData = obj; state.weekData.days.forEach(ensureDayStructure); saveJSON(state.weekKey, state.weekData);
          render();
          toastMsg('åŒ¯å…¥å®Œæˆã€‚', 'success');
        }catch(err){ alert('ç„¡æ³•è§£ææª”æ¡ˆ'); }
      };
      reader.readAsText(file);
    }

    // === ç¶å®š ===
    window.addEventListener('DOMContentLoaded', ()=>{
      initWeek();
      document.getElementById('taskList').addEventListener('change', (e)=>{
        if(e.target.matches('input[type="checkbox"][data-task-id]')){
          toggleTask(e.target.dataset.taskId, e.target.checked);
        }
      });
      document.getElementById('taskList').addEventListener('click', (e)=>{
        if(e.target.dataset.removeTaskId){
          removeTask(e.target.dataset.removeTaskId);
        }
      });
      document.getElementById('btnAddTask').addEventListener('click', ()=>{
        const category = document.getElementById('taskCategory').value;
        const detailInput = document.getElementById('taskDetail');
        const detail = detailInput.value;
        if(!category && !detail.trim()) return;
        addTask(category || 'å…¶ä»–', detail);
        detailInput.value = '';
        detailInput.focus();
      });
      document.getElementById('taskDetail').addEventListener('keydown', (e)=>{
        if(e.key==='Enter'){
          e.preventDefault();
          document.getElementById('btnAddTask').click();
        }
      });
      document.getElementById('chkParentPass').addEventListener('change', (e)=>setParentPass(e.target.checked));
      document.getElementById('btnResetToday').addEventListener('click', resetToday);
      document.getElementById('btnNewWeek').addEventListener('click', newWeek);
      document.getElementById('btnClearAll').addEventListener('click', clearAll);
      document.getElementById('btnPrint').addEventListener('click', ()=>window.print());
      document.getElementById('btnExport').addEventListener('click', exportData);
      document.getElementById('importFile').addEventListener('change', (e)=>{
        if(e.target.files && e.target.files[0]) importData(e.target.files[0]);
      });
    });
  </script>
</body>
</html>
