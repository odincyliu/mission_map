<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>è²“å’ªé—–é—œåœ°åœ–ï½œå°å››ãƒ»æ¯æ—¥ä¸€é—œ</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#fffdf7; --ink:#222; --soft:#f7efe3; --accent:#ffb703; --accent2:#8ecae6; --success:#76c893;
    }
    body{font-family:'Noto Sans TC', system-ui, -apple-system, Segoe UI, Roboto, 'Helvetica Neue', Arial; background:var(--bg); color:var(--ink);}  
    .app-title{font-weight:900; letter-spacing:1px}
    .cat-badge{font-size:1.25rem;}
    .card{border:none; border-radius:1rem; box-shadow:0 8px 24px rgba(0,0,0,.08);} 
    .map-wrap{background:linear-gradient(180deg, #fffaf0, #fff); border-radius:1rem; position:relative; padding:1.25rem}
    .checkpoint{width:72px; height:72px; border-radius:50%; background:#fff; border:3px dashed #e7d8c7; display:flex; align-items:center; justify-content:center; position:relative; transition:transform .2s;}
    .checkpoint .day{position:absolute; top:-1.25rem; font-weight:700; font-size:.9rem}
    .checkpoint .cat{font-size:2rem; line-height:1}
    .checkpoint.today{border-style:solid; border-color:var(--accent); box-shadow:0 0 0 8px rgba(255,183,3,.15);}
    .checkpoint.done{background:var(--success); border-color:var(--success); color:#fff}
    .checkpoint.done .cat{filter:grayscale(0)}
    .checkpoint:hover{transform:translateY(-2px)}
    .path{position:absolute; left:0; top:0; right:0; bottom:0; pointer-events:none}
    .paw{font-size:1.2rem; opacity:.28}
    .sticker{width:64px; height:64px; background:#fff; border:2px dashed #e7d8c7; border-radius:.75rem; display:flex; align-items:center; justify-content:center}
    .sticker.filled{border-color:var(--accent2); background:linear-gradient(180deg,#fff,#eef8ff)}
    .sticker .bigcat{font-size:1.8rem}
    .rule-list li{margin-bottom:.25rem}
    .task-check input[type="checkbox"]{transform:scale(1.2); margin-right:.4rem}
    .btn-cat{background:var(--accent); color:#000; border:none; font-weight:700}
    .btn-cat:disabled{background:#e8dcc6;color:#8b8b8b}
    .reward-panel{background:var(--soft); border-radius:.75rem; padding:.75rem; border:1px solid rgba(0,0,0,.05); min-height:100%; display:flex; flex-direction:column; gap:.35rem}
    .reward-list{margin:0; padding-left:1.25rem}

    @media print{
      .no-print{display:none !important}
      .container{max-width:100%}
      body{background:#fff}
      .card{box-shadow:none; border:1px solid #eee}
    }
  </style>
</head>
<body>
  <div class="container py-4">
    <div class="d-flex align-items-center justify-content-between mb-3">
      <h1 class="app-title">ğŸ¾ è²“å’ªé—–é—œåœ°åœ– <span class="fs-5 text-muted">ï½œå°å››ãƒ»æ¯æ—¥ä¸€é—œ</span></h1>
      <div class="no-print">
        <button id="btnPrint" class="btn btn-outline-secondary me-2">ğŸ–¨ï¸ åˆ—å°</button>
        <button id="btnExport" class="btn btn-outline-primary me-2">ğŸ“¤ åŒ¯å‡ºé€²åº¦</button>
        <label class="btn btn-outline-success mb-0">
          ğŸ“¥ åŒ¯å…¥é€²åº¦ <input type="file" id="importFile" hidden accept="application/json" />
        </label>
      </div>
    </div>

    <div class="row g-4">
      <!-- ä»Šæ—¥ä»»å‹™ -->
      <div class="col-lg-5">
        <div class="card p-3">
          <div class="d-flex align-items-center mb-2">
            <span class="cat-badge me-2">ğŸ˜º</span>
            <h5 class="mb-0">ä»Šæ—¥ä»»å‹™</h5>
          </div>
          <div id="todayInfo" class="text-muted mb-3 small"></div>

          <div id="taskList" class="mb-2"></div>
          <div id="taskCounter" class="small text-muted mb-3"></div>

          <div class="input-group input-group-sm mb-2">
            <label class="input-group-text" for="taskCategory">æ–°å¢ä»»å‹™</label>
            <select id="taskCategory" class="form-select">
              <option value="ä½œæ¥­">ä½œæ¥­</option>
              <option value="è¤‡ç¿’">è¤‡ç¿’</option>
              <option value="æ•´ç†æ›¸åŒ…">æ•´ç†æ›¸åŒ…</option>
              <option value="é–±è®€">é–±è®€</option>
              <option value="å…¶ä»–">å…¶ä»–</option>
            </select>
            <input id="taskDetail" type="text" class="form-control" placeholder="è¼¸å…¥è©³ç´°å…§å®¹ï¼Œä¾‹å¦‚ï¼šåœ‹ç¿’3" />
            <button id="btnAddTask" class="btn btn-outline-secondary">â•</button>
          </div>
          <div class="input-group input-group-sm mb-1">
            <label class="input-group-text" for="rewardType">çå‹µ</label>
            <select id="rewardType" class="form-select">
              <option value="points">é»æ•¸</option>
              <option value="custom">è‡ªè¨‚</option>
            </select>
            <input id="rewardPoints" type="number" class="form-control" min="0" value="10" placeholder="è¼¸å…¥é»æ•¸" />
            <input id="rewardCustom" type="text" class="form-control d-none" placeholder="è¼¸å…¥çå‹µå…§å®¹ï¼Œä¾‹å¦‚ï¼šç© 10 åˆ†é˜ Switch" />
          </div>
          <div class="form-text small text-muted mb-3">å¯é¸æ“‡é»æ•¸æˆ–è¼¸å…¥å…¶ä»–çå‹µå…§å®¹ã€‚</div>
          <div class="small text-muted mb-3">å®Œæˆä»Šæ—¥ä»»å‹™å¾Œæœƒè‡ªå‹•è“‹ç« ä¸¦æ”¶é›†è²¼ç´™ã€‚</div>

          <div class="d-flex gap-2">
            <button id="btnResetToday" class="btn btn-outline-danger">â†º é‡ç½®ä»Šæ—¥</button>
          </div>
          <div id="msg" class="mt-3"></div>

          <hr>
          <ul class="rule-list small mb-0">
            <li>å®Œæˆ <b>ç•¶æ—¥ä»»å‹™</b> å¾Œï¼Œç³»çµ±æœƒè‡ªå‹•è“‹ç« ä¸¦æ”¶é›†è²¼ç´™ã€‚</li>
            <li>é—–é—œç´€éŒ„æœƒä¾ç…§ Google è¡¨å–®è³‡æ–™è‡ªå‹•æ›´æ–°ä¸¦çµ±è¨ˆçå‹µã€‚</li>
            <li>æ¯é€±ä¸€æœƒè‡ªå‹•å»ºç«‹æ–°åœ°åœ–ï¼ˆä¿ç•™æ­·å²é€±è¨˜éŒ„ï¼Œä¹Ÿå¯åŒ¯å‡ºå‚™ä»½ï¼‰ã€‚</li>
          </ul>
        </div>
      </div>

      <!-- åœ°åœ–å€ -->
      <div class="col-lg-7">
        <div class="card p-3">
          <div class="d-flex align-items-center mb-2">
            <span class="cat-badge me-2">ğŸ¾</span>
            <h5 class="mb-0">æœ¬é€±é—–é—œåœ°åœ–</h5>
          </div>
          <div id="weekInfo" class="text-muted small mb-3"></div>

          <div class="map-wrap position-relative">
            <div class="row row-cols-2 row-cols-sm-4 row-cols-md-7 g-3" id="mapRow"></div>
          </div>

          <div class="mt-4">
            <div class="d-flex align-items-center mb-2">
              <span class="cat-badge me-2">ğŸ</span>
              <h6 class="mb-0">æœ¬é€±è²¼ç´™æ”¶è—</h6>
            </div>
            <div class="row g-2" id="stickerRow"></div>
          </div>

          <div class="mt-4">
            <div class="d-flex align-items-center mb-2">
              <span class="cat-badge me-2">ğŸ’</span>
              <h6 class="mb-0">çå‹µç´€éŒ„</h6>
            </div>
            <div class="row g-2 small" id="rewardSummary">
              <div class="col-12 col-md-6">
                <div class="reward-panel h-100" id="rewardToday"></div>
              </div>
              <div class="col-12 col-md-6">
                <div class="reward-panel h-100" id="rewardWeek"></div>
              </div>
            </div>
          </div>

          <div class="mt-3 d-flex gap-2 no-print">
            <button id="btnNewWeek" class="btn btn-outline-secondary">ğŸ†• é–‹æ–°åœ°åœ–ï¼ˆæœ¬é€±é‡ç½®ï¼‰</button>
            <button id="btnClearAll" class="btn btn-outline-danger">ğŸ—‘ï¸ æ¸…é™¤æ‰€æœ‰è³‡æ–™</button>
          </div>
      </div>
    </div>

  </div>

    <footer class="text-center text-muted small mt-4">
      ç”±å®¶é•·èˆ‡å­©å­ä¸€èµ·ä½¿ç”¨ï¼šå®Œæˆä»»å‹™ â†’ ç³»çµ±è‡ªå‹•åˆ¤å®šé—–é—œæˆåŠŸ â†’ æ”¶é›†å°è²“è²¼ç´™ã€‚
    </footer>
  </div>

  <script>
    // === å·¥å…· ===
    const catSet = ["ğŸ±","ğŸˆ","ğŸ˜¸","ğŸ˜º","ğŸ˜»","ğŸ˜½","ğŸ™€","ğŸ˜¼","ğŸ˜¹","ğŸ¾"]; // éš¨æ©Ÿè²¼ç´™

    // å–å¾—ç•¶åœ°æ™‚é–“ï¼ˆä»¥ä½¿ç”¨è€…ç€è¦½å™¨ç‚ºæº–ï¼‰
    function todayYMD(){
      const d = new Date();
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,'0');
      const day = String(d.getDate()).padStart(2,'0');
      return `${y}-${m}-${day}`;
    }
    function weekStart(d){ // ä»¥é€±ä¸€ç‚ºä¸€é€±èµ·å§‹
      const x = new Date(d);
      const day = x.getDay(); // 0(æ—¥)-6(å…­)
      const diff = (day===0? -6 : 1) - day; // è½‰åˆ°é€±ä¸€
      x.setDate(x.getDate()+diff);
      x.setHours(0,0,0,0);
      return x;
    }
    function fmtDate(d){
      return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
    }

    // LocalStorage Key ä»¥é€±ä¸€æ—¥æœŸå‘½å
    function storageKey(prefix){
      const ws = weekStart(new Date());
      return `${prefix}:${fmtDate(ws)}`;
    }

    function loadJSON(key, fallback){
      try{ return JSON.parse(localStorage.getItem(key)) ?? fallback; }catch(e){ return fallback; }
    }
    function saveJSON(key, obj){
      localStorage.setItem(key, JSON.stringify(obj));
    }

    // === ç‹€æ…‹ ===
    const WEEK_DAYS = ["é€±ä¸€","é€±äºŒ","é€±ä¸‰","é€±å››","é€±äº”","é€±å…­","é€±æ—¥"];

    const state = {
      weekKey: storageKey('catmap'),
      weekData: null,
      today: todayYMD(),
    };

    function uid(){
      if(window.crypto && window.crypto.randomUUID){
        return window.crypto.randomUUID();
      }
      return 't' + Math.random().toString(36).slice(2,9);
    }

    function defaultReward(){
      return {type:'points', value:10};
    }

    function markTaskSource(task, source){
      if(!task.source){ task.source = source; }
      return task;
    }

    function parseDoneFlag(value){
      if(typeof value === 'boolean'){ return value; }
      if(typeof value === 'number'){ return value !== 0; }
      if(typeof value === 'string'){
        const text = value.replace(/[\s\uFEFF]+$/u, '').trim();
        if(!text){ return false; }
        if(/^[âœ“âœ”âœ…]$/.test(text)){ return true; }
        if(text === 'æ˜¯' || text === 'å·²å®Œæˆ' || text === 'å®Œæˆ'){ return true; }
        if(text === 'å¦' || text === 'æœªå®Œæˆ'){ return false; }
        const lowered = text.toLowerCase();
        if(['true','1','y','yes','ok','done','å®Œæˆ'].includes(lowered)){ return true; }
        if(['false','0','n','no','pending'].includes(lowered)){ return false; }
      }
      return false;
    }

    function formatDoneFlag(value){
      return value ? 'æ˜¯' : 'å¦';
    }

    function defaultTasks(){
      return [
        markTaskSource({id:uid(), category:'ä½œæ¥­', detail:'', done:false, reward:defaultReward()}, 'local'),
        markTaskSource({id:uid(), category:'è¤‡ç¿’', detail:'', done:false, reward:defaultReward()}, 'local'),
        markTaskSource({id:uid(), category:'æ•´ç†æ›¸åŒ…', detail:'', done:false, reward:defaultReward()}, 'local')
      ];
    }

    function generateApiId(){
      const used = new Set();
      if(state.weekData && Array.isArray(state.weekData.days)){
        state.weekData.days.forEach(day=>{
          if(day && Array.isArray(day.tasks)){
            day.tasks.forEach(task=>{ if(task && task.id){ used.add(String(task.id)); } });
          }
        });
      }
      let id = '';
      let guard = 0;
      while(!id || used.has(id)){
        const timePart = Date.now().toString();
        const randomPart = Math.floor(Math.random()*1000).toString().padStart(3,'0');
        id = `${timePart}${randomPart}`;
        guard += 1;
        if(guard > 5){ id = `${timePart}${Math.floor(Math.random()*1e6).toString().padStart(6,'0')}`; }
      }
      return id;
    }

    function rewardFromApi(raw){
      if(raw === undefined || raw === null || raw === ''){
        return defaultReward();
      }
      if(typeof raw === 'object' && !Array.isArray(raw)){
        const holder = {reward: raw};
        ensureTaskReward(holder);
        return holder.reward;
      }
      if(typeof raw === 'number'){
        return {type:'points', value: Math.max(0, Math.round(raw))};
      }
      if(typeof raw === 'string'){
        try{
          const obj = JSON.parse(raw);
          if(obj && typeof obj === 'object'){
            const holder = {reward: obj};
            ensureTaskReward(holder);
            return holder.reward;
          }
        }catch(e){
          // ignore JSON parse error
        }
        const num = Number(raw);
        if(Number.isFinite(num)){
          return {type:'points', value: Math.max(0, Math.round(num))};
        }
        const text = raw.trim();
        if(!text){
          return defaultReward();
        }
        if(text.startsWith('custom:')){
          return {type:'custom', value:text.slice(7)};
        }
        if(text.startsWith('points:')){
          const val = Number(text.slice(7));
          if(Number.isFinite(val)){
            return {type:'points', value: Math.max(0, Math.round(val))};
          }
        }
        return {type:'custom', value:text};
      }
      return defaultReward();
    }

    function parseTaskFromApi(record){
      if(!record) return null;
      const task = {
        id: String(record.id ?? generateApiId()),
        category: 'å…¶ä»–',
        detail: '',
        done: false,
        reward: defaultReward(),
        source: 'api'
      };
      if(record.item){
        if(typeof record.item === 'string'){
          try{
            const obj = JSON.parse(record.item);
            if(obj && typeof obj === 'object'){
              if(obj.category){ task.category = String(obj.category); }
              if(obj.detail){ task.detail = String(obj.detail); }
            }else{
              const parts = record.item.split('ï½œ');
              if(parts.length > 1){
                task.category = parts[0] || task.category;
                task.detail = parts.slice(1).join('ï½œ');
              }else{
                task.detail = record.item;
              }
            }
          }catch(e){
            const parts = record.item.split('ï½œ');
            if(parts.length > 1){
              task.category = parts[0] || task.category;
              task.detail = parts.slice(1).join('ï½œ');
            }else{
              task.detail = record.item;
            }
          }
        }else if(typeof record.item === 'object'){
          if(record.item.category){ task.category = String(record.item.category); }
          if(record.item.detail){ task.detail = String(record.item.detail); }
        }
      }
      task.reward = rewardFromApi(record.reward);
      ensureTaskReward(task);
      const doneKeys = ['done','Done','DONE','å®Œæˆ ','å®Œæˆ','å·²å®Œæˆ','isDone','status'];
      const hasDoneField = doneKeys.some(key=>Object.prototype.hasOwnProperty.call(record, key));
      const doneField = record.done ?? record.Done ?? record.DONE ?? record['å®Œæˆ '] ?? record['å®Œæˆ'] ?? record['å·²å®Œæˆ'] ?? record['isDone'] ?? record['status'];
      task.done = parseDoneFlag(doneField);
      task._hasRemoteDone = hasDoneField;
      return task;
    }

    function encodeTaskForApi({id, category, detail, reward, done}, date){
      return {
        id: String(id),
        date,
        item: JSON.stringify({category, detail}),
        reward: JSON.stringify(reward),
        done: formatDoneFlag(!!done)
      };
    }

    function ensureTaskReward(task){
      if(!task.reward || typeof task.reward !== 'object'){
        task.reward = defaultReward();
      }
      const r = task.reward;
      if(r.type === 'custom'){
        task.reward = {type:'custom', value: String(r.value ?? '').trim()};
      }else if(r.type === 'points'){
        const num = Number(r.value);
        const safe = Number.isFinite(num) ? Math.max(0, Math.round(num)) : 0;
        task.reward = {type:'points', value: safe};
      }else{
        const fallback = Number(r.value);
        const safe = Number.isFinite(fallback) ? Math.max(0, Math.round(fallback)) : 0;
        task.reward = {type:'points', value: safe};
      }
      return task.reward;
    }

    function refreshDayStatus(day, {silent=true}={}){
      if(!day){
        return {total:0, doneCount:0, completed:false};
      }
      ensureDayStructure(day);
      const total = Array.isArray(day.tasks) ? day.tasks.length : 0;
      let doneCount = 0;
      if(Array.isArray(day.tasks)){
        day.tasks.forEach(task=>{ if(task && task.done){ doneCount += 1; } });
      }
      const completed = total > 0 && doneCount > 0;
      const prev = !!day.passed;
      day.passed = completed;
      if(completed){
        if(!day.sticker){
          day.sticker = catSet[Math.floor(Math.random()*catSet.length)];
        }
      }else if(day.sticker){
        day.sticker = '';
      }
      if(!silent && completed !== prev){
        if(completed){
          toastMsg(`ä»Šæ—¥ä»»å‹™å·²å®Œæˆï¼å¾—åˆ°è²¼ç´™ ${day.sticker || 'ğŸ¾'}`, 'success');
        }else{
          toastMsg('å·²å–æ¶ˆä»Šæ—¥é—–é—œæˆåŠŸã€‚', 'info');
        }
      }
      return {total, doneCount, completed};
    }

    function getTaskRewardLabel(task){
      const reward = ensureTaskReward(task);
      if(reward.type === 'custom'){
        return reward.value || 'æœªè¨­å®š';
      }
      return `${reward.value || 0} é»`;
    }

    function collectRewardsFromDay(day){
      const summary = {points:0, custom:[], doneCount:0};
      if(!day || !Array.isArray(day.tasks)) return summary;
      day.tasks.forEach(task=>{
        ensureTaskReward(task);
        if(!task.done) return;
        summary.doneCount += 1;
        if(task.reward.type === 'points'){
          summary.points += Number(task.reward.value) || 0;
        }else if(task.reward.type === 'custom'){
          const text = (task.reward.value || '').trim();
          if(text){ summary.custom.push(text); }
        }
      });
      return summary;
    }

    function updateRewardSummary(){
      const todayBox = document.getElementById('rewardToday');
      const weekBox = document.getElementById('rewardWeek');
      if(!todayBox || !weekBox || !state.weekData || !Array.isArray(state.weekData.days)) return;
      const idx = dayIndexByDate(state.today);
      const day = state.weekData.days[idx];
      if(day){ ensureDayStructure(day); }

      const todaySummary = collectRewardsFromDay(day);
      const todayParts = ['<div class="fw-bold mb-1">ä»Šæ—¥çå‹µ</div>'];
      if(!todaySummary.doneCount){
        todayParts.push('<div class="text-muted">å°šæœªå®Œæˆä»»å‹™ã€‚</div>');
      }else{
        todayParts.push(`<div class="mb-1">é»æ•¸ï¼š<strong>${todaySummary.points}</strong> é»</div>`);
        if(todaySummary.custom.length){
          todayParts.push('<div>å…¶ä»–çå‹µï¼š</div>');
          todayParts.push(`<ul class="reward-list mb-0">${todaySummary.custom.map(item=>`<li>${item}</li>`).join('')}</ul>`);
        }else{
          todayParts.push('<div class="text-muted">ç„¡å…¶ä»–çå‹µè¨˜éŒ„ã€‚</div>');
        }
      }
      todayBox.innerHTML = todayParts.join('');

      let weekPoints = 0;
      const weekCustom = [];
      let weekHasAny = false;
      state.weekData.days.forEach((d, i)=>{
        ensureDayStructure(d);
        const summary = collectRewardsFromDay(d);
        if(summary.doneCount){ weekHasAny = true; }
        weekPoints += summary.points;
        if(summary.custom.length){
          summary.custom.forEach(text=>weekCustom.push(`${WEEK_DAYS[i]}ï¼š${text}`));
        }
      });

      const weekParts = ['<div class="fw-bold mb-1">æœ¬é€±ç´¯ç©</div>'];
      if(!weekHasAny && weekPoints === 0 && weekCustom.length === 0){
        weekParts.push('<div class="text-muted">å°šæœªç´¯ç©çå‹µã€‚</div>');
      }else{
        weekParts.push(`<div class="mb-1">é»æ•¸ï¼š<strong>${weekPoints}</strong> é»</div>`);
        if(weekCustom.length){
          weekParts.push('<div>å…¶ä»–çå‹µï¼š</div>');
          weekParts.push(`<ul class="reward-list mb-0">${weekCustom.map(item=>`<li>${item}</li>`).join('')}</ul>`);
        }else{
          weekParts.push('<div class="text-muted">ç„¡å…¶ä»–çå‹µè¨˜éŒ„ã€‚</div>');
        }
      }
      weekBox.innerHTML = weekParts.join('');
    }

    function ensureDayStructure(day){
      if(!day.tasks){
        day.tasks = defaultTasks();
      }else if(!Array.isArray(day.tasks)){
        const obj = day.tasks;
        const arr = [];
        if(Object.prototype.hasOwnProperty.call(obj, 'hw')){
          arr.push(markTaskSource({id:uid(), category:'ä½œæ¥­', detail:'', done:!!obj.hw, reward:defaultReward()}, 'local'));
        }
        if(Object.prototype.hasOwnProperty.call(obj, 'review')){
          arr.push(markTaskSource({id:uid(), category:'è¤‡ç¿’', detail:'', done:!!obj.review, reward:defaultReward()}, 'local'));
        }
        if(Object.prototype.hasOwnProperty.call(obj, 'bag')){
          arr.push(markTaskSource({id:uid(), category:'æ•´ç†æ›¸åŒ…', detail:'', done:!!obj.bag, reward:defaultReward()}, 'local'));
        }
        day.tasks = arr.length ? arr : defaultTasks();
      }
      if(typeof day.passed !== 'boolean'){ day.passed = !!day.passed; }
      if(typeof day.sticker !== 'string'){ day.sticker = day.sticker ? String(day.sticker) : ''; }
      day.tasks.forEach(task=>{
        ensureTaskReward(task);
        if(!task.id){ task.id = uid(); }
        markTaskSource(task, 'local');
      });
    }

    function initWeek(){
      const ws = weekStart(new Date());
      const we = new Date(ws); we.setDate(we.getDate()+6);
      const weekTitle = `${fmtDate(ws)} ~ ${fmtDate(we)}`;
      document.getElementById('weekInfo').textContent = `æœ¬é€±ï¼š${weekTitle}`;

      const key = state.weekKey;
      const defaultData = {
        weekStart: fmtDate(ws),
        days: Array.from({length:7}, (_,i)=>({
          date: fmtDate(new Date(ws.getFullYear(), ws.getMonth(), ws.getDate()+i)),
          tasks: defaultTasks(),
          passed: false,
          sticker: ''
        }))
      };
      state.weekData = loadJSON(key, defaultData);
      // è‹¥è·¨é€±ï¼Œè‡ªå‹•æ–°å»º
      if(state.weekData.weekStart !== fmtDate(ws)){
        state.weekData = defaultData;
        saveJSON(key, state.weekData);
      }
      state.weekData.days.forEach(day=>{
        ensureDayStructure(day);
        refreshDayStatus(day, {silent:true});
      });
      render();
      syncWeekFromApi();
    }

    async function syncWeekFromApi(){
      if(!state.weekData){ return; }
      const ws = new Date(state.weekData.weekStart);
      const we = new Date(ws);
      we.setDate(we.getDate()+6);
      const startStr = fmtDate(ws);
      const endStr = fmtDate(we);
      try{
        const records = await apiFetchRange(startStr, endStr);
        const tasksByDate = new Map();
        records.forEach(rec=>{
          const dateStr = rec.date ? String(rec.date).trim() : '';
          if(!dateStr) return;
          const task = parseTaskFromApi(rec);
          if(!task) return;
          if(!tasksByDate.has(dateStr)){
            tasksByDate.set(dateStr, []);
          }
          tasksByDate.get(dateStr).push(task);
        });

        state.weekData.days.forEach(day=>{
          if(!day) return;
          ensureDayStructure(day);
          const existingMap = new Map();
          day.tasks.forEach(t=>{ existingMap.set(String(t.id), t); });
          const incoming = tasksByDate.get(day.date) || [];
          if(incoming.length){
            incoming.forEach(task=>{
              const prev = existingMap.get(String(task.id));
              if(prev && !task._hasRemoteDone){ task.done = !!prev.done; }
              ensureTaskReward(task);
              markTaskSource(task, 'api');
              delete task._hasRemoteDone;
            });
            day.tasks = incoming;
          }else{
            // ç§»é™¤èˆŠçš„ API ä»»å‹™ï¼Œä¿ç•™æœ¬åœ°é è¨­ä»»å‹™
            day.tasks = day.tasks.filter(t=>t.source !== 'api');
            if(!day.tasks.length){
              day.tasks = defaultTasks();
            }
          }
          refreshDayStatus(day, {silent:true});
        });
        saveJSON(state.weekKey, state.weekData);
        render();
        toastMsg('å·²å¾é›²ç«¯è¼‰å…¥æœ¬é€±ä»»å‹™ã€‚', 'success');
      }catch(err){
        console.error(err);
        toastMsg('é›²ç«¯è³‡æ–™è¼‰å…¥å¤±æ•—ï¼Œä½¿ç”¨æœ¬åœ°è³‡æ–™ã€‚', 'warning');
      }
    }

    function dayIndexByDate(dateStr){
      return state.weekData.days.findIndex(d=>d.date===dateStr);
    }

    function render(){
      const mapRow = document.getElementById('mapRow');
      mapRow.innerHTML = '';
      const stickerRow = document.getElementById('stickerRow');
      stickerRow.innerHTML = '';

      const todayStr = state.today;
      const todayIdx = dayIndexByDate(todayStr);

      state.weekData.days.forEach((d, i)=>{
        const status = refreshDayStatus(d, {silent:true});
        const isToday = i===todayIdx;
        const isDone = !!status.completed;
        const col = document.createElement('div');
        const cp = document.createElement('div');
        cp.className = 'checkpoint d-flex flex-column text-center mx-auto ' + (isToday? 'today ':'') + (isDone? 'done ':'');
        cp.innerHTML = `<div class="day">${WEEK_DAYS[i]}</div><div class="cat">${isDone ? 'ğŸ…' : 'ğŸ¾'}</div>`;
        col.appendChild(cp);
        mapRow.appendChild(col);

        const sCol = document.createElement('div'); sCol.className='col-3 col-md-2 col-lg-1';
        const sticker = document.createElement('div');
        sticker.className = 'sticker ' + (d.sticker? 'filled':'');
        sticker.title = d.date;
        sticker.innerHTML = `<span class="bigcat">${d.sticker || 'ğŸ”²'}</span>`;
        sCol.appendChild(sticker); stickerRow.appendChild(sCol);
      });

      const dNow = new Date();
      const info = document.getElementById('todayInfo');
      info.textContent = `ä»Šå¤©ï¼š${fmtDate(dNow)}ï¼ˆ${['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'][dNow.getDay()]}ï¼‰`;

      renderTodayTasks();
    }

    function renderTodayTasks(){
      const container = document.getElementById('taskList');
      container.innerHTML = '';
      const idx = dayIndexByDate(state.today);
      const day = state.weekData.days[idx];
      if(!day){
        updateRewardSummary();
        return;
      }
      ensureDayStructure(day);
      const status = refreshDayStatus(day, {silent:true});
      const totalCount = status.total;
      const doneCount = status.doneCount;
      day.tasks.forEach(task=>{
        ensureTaskReward(task);
        const wrapper = document.createElement('div');
        wrapper.className = 'task-check form-check d-flex align-items-start justify-content-between gap-3 mb-2 flex-wrap';

        const left = document.createElement('div');
        left.className = 'd-flex align-items-center flex-grow-1';

        const checkbox = document.createElement('input');
        checkbox.className = 'form-check-input me-2';
        checkbox.type = 'checkbox';
        checkbox.id = `task-${task.id}`;
        checkbox.dataset.taskId = task.id;
        checkbox.checked = !!task.done;

        const label = document.createElement('label');
        label.className = 'form-check-label flex-grow-1';
        label.setAttribute('for', checkbox.id);
        label.textContent = task.detail ? `${task.category} - ${task.detail}` : task.category;

        left.appendChild(checkbox);
        left.appendChild(label);

        const right = document.createElement('div');
        right.className = 'd-flex flex-column align-items-end gap-1';

        const rewardBadge = document.createElement('span');
        rewardBadge.className = 'badge text-bg-warning text-dark';
        rewardBadge.textContent = `ğŸ ${getTaskRewardLabel(task)}`;
        rewardBadge.title = 'å®Œæˆæ­¤ä»»å‹™å¯ç²å¾—çš„çå‹µ';

        const removeBtn = document.createElement('button');
        removeBtn.className = 'btn btn-sm btn-outline-danger';
        removeBtn.type = 'button';
        removeBtn.dataset.removeTaskId = task.id;
        removeBtn.textContent = 'åˆªé™¤';

        right.appendChild(rewardBadge);
        right.appendChild(removeBtn);

        wrapper.appendChild(left);
        wrapper.appendChild(right);
        container.appendChild(wrapper);
      });

      const counter = document.getElementById('taskCounter');
      if(counter){
        const completionMsg = status.completed ? 'ä»Šæ—¥ä»»å‹™å·²å®Œæˆï¼Œå·²è‡ªå‹•è“‹ç« ï¼' : 'å®Œæˆä»»å‹™å¾Œæœƒè‡ªå‹•è“‹ç« ä¸¦æ”¶é›†è²¼ç´™ã€‚';
        const counterMsg = totalCount
          ? `å·²å®Œæˆ ${doneCount} / ${totalCount} é …ä»»å‹™ã€‚${completionMsg}`
          : 'å°šæœªåŠ å…¥ä»»å‹™ã€‚';
        counter.textContent = counterMsg;
      }

      updateRewardSummary();
    }

    function toggleTask(taskId, value){
      const idx = dayIndexByDate(state.today);
      const day = state.weekData.days[idx];
      const task = day.tasks.find(t=>t.id===taskId);
      if(!task) return;
      task.done = !!value;
      refreshDayStatus(day, {silent:false});
      saveJSON(state.weekKey, state.weekData);
      render();
    }

    async function addTask(category, detail, reward){
      const idx = dayIndexByDate(state.today);
      const day = state.weekData.days[idx];
      ensureDayStructure(day);
      const trimmedDetail = detail.trim();
      const taskId = generateApiId();
      const task = markTaskSource({ id: taskId, category, detail: trimmedDetail, done: false, reward: reward || defaultReward() }, 'api');
      ensureTaskReward(task);
      const payload = encodeTaskForApi(task, day.date);
      try{
        await apiAddRecord(payload);
        day.tasks = day.tasks.filter(t=>!(t.source === 'api' && String(t.id) === String(taskId)));
        day.tasks.push(task);
        refreshDayStatus(day, {silent:true});
        saveJSON(state.weekKey, state.weekData);
        render();
        toastMsg('å·²æ–°å¢ä»»å‹™ä¸¦åŒæ­¥é›²ç«¯ã€‚', 'success');
      }catch(err){
        console.error(err);
        toastMsg(`æ–°å¢ä»»å‹™å¤±æ•—ï¼š${err.message}`, 'warning');
        throw err;
      }
    }

    async function removeTask(taskId){
      const idx = dayIndexByDate(state.today);
      const day = state.weekData.days[idx];
      const before = day.tasks.length;
      const task = day.tasks.find(t=>String(t.id)===String(taskId));
      if(!task){ return; }
      if(task.source === 'api'){
        try{
          await apiDeleteRecord(String(taskId));
        }catch(err){
          console.error(err);
          toastMsg(`åˆªé™¤ä»»å‹™å¤±æ•—ï¼š${err.message}`, 'warning');
          throw err;
        }
      }
      day.tasks = day.tasks.filter(t=>String(t.id)!==String(taskId));
      if(day.tasks.length !== before){
        refreshDayStatus(day, {silent:true});
        saveJSON(state.weekKey, state.weekData);
        render();
        toastMsg('å·²åˆªé™¤ä»»å‹™ã€‚', 'info');
      }
    }

    function resetToday(){
      const idx = dayIndexByDate(state.today);
      const day = state.weekData.days[idx];
      day.tasks = defaultTasks();
      day.passed = false; day.sticker='';
      refreshDayStatus(day, {silent:true});
      saveJSON(state.weekKey, state.weekData);
      render();
      toastMsg('å·²é‡ç½®ä»Šæ—¥é€²åº¦ã€‚', 'info');
    }

    function newWeek(){
      if(!confirm('ç¢ºå®šè¦é‡ç½®æœ¬é€±åœ°åœ–ï¼Ÿæ­¤å‹•ä½œä¸å¯å¾©åŸã€‚')) return;
      const ws = weekStart(new Date());
      state.weekData = {
        weekStart: fmtDate(ws),
        days: Array.from({length:7}, (_,i)=>({
          date: fmtDate(new Date(ws.getFullYear(), ws.getMonth(), ws.getDate()+i)),
          tasks: defaultTasks(),
          passed:false, sticker:''
        }))
      };
      saveJSON(state.weekKey, state.weekData);
      render();
      syncWeekFromApi();
      toastMsg('å·²å»ºç«‹æ–°åœ°åœ–ã€‚', 'info');
    }

    function clearAll(){
      if(!confirm('æ¸…é™¤æ‰€æœ‰å„²å­˜è³‡æ–™ï¼Ÿï¼ˆåŒ…å«æ­·å²é€±ï¼‰')) return;
      Object.keys(localStorage).forEach(k=>{ if(k.startsWith('catmap:')) localStorage.removeItem(k); });
      initWeek();
      toastMsg('è³‡æ–™å·²å…¨éƒ¨æ¸…é™¤ã€‚', 'info');
    }

    function toastMsg(text, type='info'){
      const msg = document.getElementById('msg');
      const cls = type==='success'? 'alert-success' : (type==='info'? 'alert-secondary' : 'alert-warning');
      msg.innerHTML = `<div class="alert ${cls} py-2 px-3 mb-0">${text}</div>`;
      setTimeout(()=>{ msg.innerHTML=''; }, 2800);
    }

    function exportData(){
      const blob = new Blob([JSON.stringify(state.weekData, null, 2)], {type:'application/json'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `catmap-${state.weekData.weekStart}.json`;
      document.body.appendChild(a); a.click(); a.remove();
    }

    function importData(file){
      const reader = new FileReader();
      reader.onload = (e)=>{
        try{
          const obj = JSON.parse(e.target.result);
          if(!obj || !obj.weekStart || !Array.isArray(obj.days) || obj.days.length!==7){
            alert('æ ¼å¼ä¸æ­£ç¢º'); return;
          }
          state.weekData = obj;
          state.weekData.days.forEach(day=>{
            ensureDayStructure(day);
            refreshDayStatus(day, {silent:true});
          });
          saveJSON(state.weekKey, state.weekData);
          render();
          toastMsg('åŒ¯å…¥å®Œæˆã€‚', 'success');
        }catch(err){ alert('ç„¡æ³•è§£ææª”æ¡ˆ'); }
      };
      reader.readAsText(file);
    }

    const API_URL = 'https://script.google.com/macros/s/AKfycby30UjHuZoxAxr-l6-HbJd8H0K3YTNEEfnRyrm9yOj5egBKJXBgMpEtKYxhVem6uA6t/exec';

    async function apiFetchRange(start, end){
      const url = `${API_URL}?mode=range&startDate=${encodeURIComponent(start)}&endDate=${encodeURIComponent(end)}`;
      const resp = await fetch(url);
      if(!resp.ok){
        throw new Error(`API è«‹æ±‚å¤±æ•— (${resp.status})`);
      }
      const data = await resp.json();
      if(!data.success){
        throw new Error(data.message || 'API æŸ¥è©¢å¤±æ•—');
      }
      return Array.isArray(data.data) ? data.data : [];
    }

    async function apiAddRecord({id, date, item, reward, done}){
      const body = new URLSearchParams();
      body.append('action', 'add');
      body.append('id', id);
      body.append('date', date);
      body.append('item', item);
      body.append('reward', reward);
      const doneValue = typeof done === 'string' ? done : formatDoneFlag(!!done);
      body.append('done', doneValue);
      body.append('å®Œæˆ ', doneValue);
      body.append('å®Œæˆ', doneValue);

      const resp = await fetch(API_URL, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8'
        },
        body: body.toString()
      });
      if(!resp.ok){
        throw new Error(`API è«‹æ±‚å¤±æ•— (${resp.status})`);
      }
      const data = await resp.json();
      if(!data.success){
        throw new Error(data.message || 'æ–°å¢å¤±æ•—');
      }
      return data;
    }

    async function apiDeleteRecord(id){
      const body = new URLSearchParams();
      body.append('action', 'delete');
      body.append('id', id);

      const resp = await fetch(API_URL, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8'
        },
        body: body.toString()
      });
      if(!resp.ok){
        throw new Error(`API è«‹æ±‚å¤±æ•— (${resp.status})`);
      }
      const data = await resp.json();
      if(!data.success){
        throw new Error(data.message || 'åˆªé™¤å¤±æ•—');
      }
      return data;
    }

    // === ç¶å®š ===
    window.addEventListener('DOMContentLoaded', ()=>{
      initWeek();
      document.getElementById('taskList').addEventListener('change', (e)=>{
        if(e.target.matches('input[type="checkbox"][data-task-id]')){
          toggleTask(e.target.dataset.taskId, e.target.checked);
        }
      });
      document.getElementById('taskList').addEventListener('click', (e)=>{
        if(e.target.dataset.removeTaskId){
          const btn = e.target;
          btn.disabled = true;
          removeTask(e.target.dataset.removeTaskId)
            .catch(()=>{})
            .finally(()=>{ btn.disabled = false; });
        }
      });
      const addTaskButton = document.getElementById('btnAddTask');
      addTaskButton.addEventListener('click', async ()=>{
        const category = document.getElementById('taskCategory').value;
        const detailInput = document.getElementById('taskDetail');
        const detail = detailInput.value;
        const rewardType = document.getElementById('rewardType').value;
        const rewardPoints = document.getElementById('rewardPoints');
        const rewardCustom = document.getElementById('rewardCustom');
        if(!category && !detail.trim()) return;
        let reward;
        if(rewardType === 'custom'){
          reward = {type:'custom', value:(rewardCustom.value || '').trim()};
        }else{
          const num = Number(rewardPoints.value);
          const safe = Number.isFinite(num) ? Math.max(0, Math.round(num)) : 0;
          reward = {type:'points', value:safe};
        }
        addTaskButton.disabled = true;
        try{
          await addTask(category || 'å…¶ä»–', detail, reward);
          detailInput.value = '';
          detailInput.focus();
          if(rewardType === 'custom'){
            rewardCustom.value = '';
          }
        }catch(err){
          // è‹¥å¤±æ•—å‰‡ä¿æŒè¼¸å…¥å…§å®¹ä¾›ä½¿ç”¨è€…èª¿æ•´
        }finally{
          addTaskButton.disabled = false;
        }
      });
      document.getElementById('taskDetail').addEventListener('keydown', (e)=>{
        if(e.key==='Enter'){
          e.preventDefault();
          document.getElementById('btnAddTask').click();
        }
      });
      const rewardTypeSelect = document.getElementById('rewardType');
      const rewardPointsInput = document.getElementById('rewardPoints');
      const rewardCustomInput = document.getElementById('rewardCustom');
      function syncRewardInputs(){
        if(rewardTypeSelect.value === 'custom'){
          rewardPointsInput.classList.add('d-none');
          rewardCustomInput.classList.remove('d-none');
          rewardCustomInput.focus();
        }else{
          rewardPointsInput.classList.remove('d-none');
          rewardCustomInput.classList.add('d-none');
        }
      }
      rewardTypeSelect.addEventListener('change', syncRewardInputs);
      syncRewardInputs();
      document.getElementById('btnResetToday').addEventListener('click', resetToday);
      document.getElementById('btnNewWeek').addEventListener('click', newWeek);
      document.getElementById('btnClearAll').addEventListener('click', clearAll);
      document.getElementById('btnPrint').addEventListener('click', ()=>window.print());
      document.getElementById('btnExport').addEventListener('click', exportData);
      document.getElementById('importFile').addEventListener('change', (e)=>{
        if(e.target.files && e.target.files[0]) importData(e.target.files[0]);
      });

    });
  </script>
</body>
</html>
